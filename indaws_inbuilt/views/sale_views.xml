<?xml version="1.0" encoding="UTF-8" ?>
<odoo>
    <data>
        <record id="inherit_sale_order_view_form" model="ir.ui.view">
            <field name="name">inherit.sale.order.views.form</field>
            <field name="model">sale.order</field>
            <field name="priority">50</field>
            <field name="inherit_id" ref="sale.view_order_form"/>
            <field name="arch" type="xml">
                <xpath expr="//field[@name='partner_id']" position="after">
                    <field name="test_field" invisible="1"/>
                </xpath>
                <xpath expr="//group[@name='sales_person']//field[@name='client_order_ref']" position="attributes">
                    <attribute name="invisible">1</attribute>
                </xpath>
                <xpath expr="//page[@name='order_lines']//field[@name='order_line']//tree" position="attributes">
                    <attribute name="editable">bottom</attribute>
<!--                    <attribute name="default_order">capitulo_id</attribute>-->
                </xpath>
                <xpath expr="//page[@name='order_lines']//field[@name='order_line']//tree//field[@name='product_id']" position="before">
                    <field name="order_id" invisible="1"/>
                    <field name="capitulo_id" context="{'order_id': order_id}" />
                    <field name="code"/>
                </xpath>

                <xpath expr="//page[@name='optional_products']" position="attributes">
                    <attribute name="invisible">1</attribute>
                </xpath>
                <xpath expr="//page[@name='order_lines']//field[@name='order_line']//form//field[@name='product_id']" position="before">
                    <field name="code" invisible="1"/>
                    <field name="order_id_domain" invisible="1" widget="many2many_tags"/>
                    <field name="capitulo_id" domain="[('order_id','in',order_id_domain)]" options="{'no_quick_create':True,'no_create_edit':True}" required="0"/>
                </xpath>
                <xpath expr="//page[@name='order_lines']//field[@name='order_line']//form//div[@name='lead']"
                       position="attributes">
                    <attribute name="invisible">1</attribute>
                </xpath>
                <xpath expr="//page[@name='order_lines']//field[@name='order_line']//form//label[@for='customer_lead']"
                       position="attributes">
                    <attribute name="invisible">1</attribute>
                </xpath>
                <xpath expr="//page[@name='order_lines']//field[@name='order_line']//form//div[@name='invoice_lines']"
                       position="attributes">
                    <attribute name="invisible">1</attribute>
                </xpath>
                <xpath expr="//page[@name='order_lines']//field[@name='order_line']//tree//field[@name='product_id']" position="attributes">
                    <attribute name="options">{'no_open': True}</attribute>
                </xpath>

                <xpath expr="//field[@name='order_line']//form//group[1]" position="attributes">
                    <attribute name="string">Partidas</attribute>
                </xpath>

                <xpath expr="//page[@name='order_lines']//field[@name='order_line']//form//div[@name='invoice_lines']" position="after">
                    <notebook>
                        <page string="Unidades de Obra" name="unidades_obra">
                            <field name="unidades_ids" force_save="1">
                                <tree editable="bottom">
                                    <field name="product_id" domain="[('product_type_unit','!=',False)]" />
                                    <field name="product_type_calc" readonly="1" optional="hidden" />
                                    <field name="comment" optional="hidden" />
                                    <field name="quantity" />
                                    <field name="uom_id" optional="hidden" />
                                    <field name="cost_unit" />
                                    <field name="incremento" readonly="False" force_save="1" />
                                    <field name="price_unit" />
                                    <field name="price_subtotal" />
                                    <field name="cost_subtotal" />
                                </tree>
                            </field>
                        </page>
                        <page string="Mediciones" name="mediciones">
                            <field name="measurement_ids" force_save="1">
                                <tree editable="bottom">
                                    <field name="description"/>
                                    <field name="units"/>
                                    <field name="length"/>
                                    <field name="width"/>
                                    <field name="height"/>
                                    <field name="partial"/>
                                </tree>
                            </field>

                            <group>
                                <group class="oe_subtotal_footer oe_right" name="total_measurement">
                                    <span class="o_td_label float-start">
                                        <label class="fw-bold" for="total_measurement" string="Cantidad Total"/>
                                    </span>
                                    <field name="total_measurement" nolabel="1"/>
                                </group>
                            </group>

                        </page>
                    </notebook>
                </xpath>

                <xpath expr="//page[@name='order_lines']" position="before">
                    <page name="capitulos_fields" string="Capitulos">
                        <button type="action" name="%(indaws_inbuilt.action_sale_capitulo_wizard)d" string="Crear Capitulos"
                            class="btn btn-primary"/>
                        <field name="sale_capitule_line">
                            <tree editable="0" create="0" delete="0" edit="0">
                                <field name="code" readonly="1" force_save="1"/>
                                <field name="name" readonly="1" force_save="1"/>
                                <field name="comment" readonly="1"/>
                                <field name="cost_price" readonly="1"/>
                                <field name="price_subtotal" readonly="1"/>
                            </tree>
                            <form>
                                <group>
                                    <group>
                                        <field name="code" readonly="1" force_save="1"/>
                                        <field name="order_id" readonly="1"/>
                                        <field name="cost_price" readonly="1"/>
                                    </group>
                                    <group>
                                        <field name="name"/>
                                        <field name="comment" readonly="1"/>
                                        <field name="price_subtotal" readonly="1"/>
                                    </group>
                                </group>
                                <field name="line_ids" readonly="1">
                                    <tree>
                                        <field name="product_id"/>
                                        <field name="name"/>
                                        <field name="product_uom_qty"/>
                                        <field name="price_unit"/>
                                        <field name="price_subtotal"/>
                                    </tree>
                                </field>
                            </form>
                        </field>
                    </page>
                </xpath>
                <xpath expr="//page[@name='order_lines']//field[@name='order_line']//form//group//group" position="after">
                    <group>
                        <field name="price_type"/>
                        <field name="incremento" force_save="1" attrs="{'invisible':[('price_type','=', 'manual')]}"
                               string="% incremento por defecto"/>
                        <field name="unidades_count" invisible="1"/>
                    </group>
                </xpath>
                <xpath expr="//page[@name='order_lines']//field[@name='order_line']/tree"
                       position="attributes">
                    <attribute name="editable">bottom</attribute>
                </xpath>
                <xpath expr="//page[@name='order_lines']//field[@name='order_line']/tree" position="inside">
                    <button type="object" name="open_sale_order_form_view" string="EDITAR" class="btn btn-primary" attrs="{'invisible': [('id', '=', False)]}"/>
                </xpath>

                <xpath expr="//page[@name='order_lines']//field[@name='order_line']//form//field[@name='price_unit']" position="attributes">
                    <attribute name="attrs">{'readonly':[('price_type','=', 'autom√°tico')]}</attribute>
                    <attribute name="force_save">1</attribute>
                </xpath>

                <xpath expr="//page[@name='order_lines']//field[@name='order_line']//form//field[@name='product_uom_qty']"
                       position="attributes">
                    <attribute name="attrs">{'readonly':0}</attribute>
                </xpath>

                <xpath expr="//page[@name='order_lines']" position="after">
                    <page name="resumen_de_coste" string="Resumen de Coste">
                        <group>
                            <group string="Costes Directos">
                                <field name="direct_costs_ids" >
                                    <tree>
                                        <field optional="show" name="name" string="Tipo"/>
                                        <field optional="show" name="quantity" string="Cantidad"/>
                                        <field optional="show" name="coste" string="Coste"/>
                                        <field name="currency_id" invisible="1"/>
                                    </tree>
                                </field>
                                <field name="coste_directo"/>
                            </group>
                            <group string="Margen Directo">
                                <field name="amount_untaxed"/>
                                <field name="margen_euros"/>
                                <field name="margen_percentage"/>
                            </group>
                        </group>

                        <group>
                            <group string="Costes Indirectos">
                                <field name="ptje_gastos_indirectos"/>
                                <field name="gastos_indirectos_euros"/>
                            </group>
                            <group string="Margen Real">
                                <field name="margen_real_euros"/>
                                <field name="margen_real_percentage"/>
                            </group>
                        </group>
                        <group>
                            <group string="Coste Total">
                                <field name="coste_total"/>
                            </group>
                        </group>
                    </page>
                </xpath>
                <xpath expr="//page[@name='order_lines']" position="attributes">
                    <attribute name="string">Partidas</attribute>
                </xpath>

                <xpath expr="//field[@name='payment_term_id']" position="after">
                    <field name="project_id"/>
                    <field name="client_order_ref"/>
                </xpath>

                <xpath expr="//button[@name='action_cancel']" position="before">
                    <button name="create_obra" string="Crear Obra" class="btn-primary" type="object" attrs="{'invisible':[('project_id','!=', False)]}"/>
                    <button name="actulizar_obra" string="Actualizar obra" class="btn-primary" type="object" attrs="{'invisible':[('project_id','=', False)]}"/>
                </xpath>

                <xpath expr="//button[@name='action_view_invoice']" position="replace">
                    <field name="invoice_count" invisible="1"/>
                </xpath>

                <xpath expr="//button[@name='action_view_delivery']" position="replace"/>

                <xpath expr="/form/header/field[@name='authorized_transaction_ids']" position="after">
                    <field name="invoice_order" invisible="1"/>
                </xpath>

                <xpath expr="//button[@id='create_invoice']" position="attributes">
                    <attribute name="attrs">{'invisible': ['|', ('invoice_status', '!=', 'to invoice'), ('invoice_order', '=', False)]}</attribute>
                </xpath>

                <xpath expr="//button[@id='create_invoice_percentage']" position="attributes">
                    <attribute name="attrs">{'invisible': ['|', ('invoice_order', '=', False), '|',('invoice_status', '!=', 'no'), ('state', '!=', 'sale')]}</attribute>
                </xpath>

            </field>
        </record>


        <record id="inherit_sale_order_contact" model="ir.ui.view">
            <field name="name">inherit.sale.order.form.contact</field>
            <field name="model">sale.order</field>
            <field name="inherit_id" ref="sale_management.sale_order_form_quote"/>
            <field name="arch" type="xml">
                <xpath expr="//field[@name='sale_order_template_id']" position="after">
                    <field name="contact_id" domain="[('parent_id','=', partner_id)]"/>
                </xpath>
            </field>
        </record>

<!--        <record id="view_order_form_inherit_sale_stock" model="ir.ui.view">-->
<!--            <field name="name">view.order.form.inherit.sale.stock</field>-->
<!--            <field name="model">sale.order</field>-->
<!--            <field name="inherit_id" ref="sale_stock.view_order_form_inherit_sale_stock"/>-->
<!--            <field name="arch" type="xml">-->
<!--                <xpath expr="//button[@name='action_view_delivery']" position="replace"/>-->
<!--            </field>-->
<!--        </record>-->

        <record id="view_order_form_inherit_sale_project_custom_bevia" model="ir.ui.view">
            <field name="name">view.order.form.inherit.sale.project.custom.bevia</field>
            <field name="model">sale.order</field>
            <field name="inherit_id" ref="sale_project.view_order_form_inherit_sale_project"/>
            <field name="arch" type="xml">
                <xpath expr="//button[@name='action_view_project_ids']/field[@name='project_count']" position="attributes">
                    <attribute name="invisible">1</attribute>
                </xpath>

                <xpath expr="//button[@name='action_view_project_ids']" position="attributes">
                    <attribute name="string">Obra</attribute>
                    <attribute name="name">get_project_form</attribute>
                    <attribute name="attrs">{'invisible': [('project_ids', '=', [])]}</attribute>
                </xpath>

                <xpath expr="//button[@name='get_project_form']" position="after">
                    <button type="object" name="view_capitulos_list" string="Capitulos" class="oe_stat_button" icon="fa-bars icon"/>
                    <button type="object" name="view_sale_order_line" string="Partidas" class="oe_stat_button" icon="fa-bars icon"/>
                    <button type="object" name="view_sale_unidad_obra" string="Ud de obra" class="oe_stat_button" icon="fa-bars icon"/>
                </xpath>
                <xpath expr="//button[@name='action_preview_sale_order']" position="after">
                    <button type="object"
                        name="action_view_delivery"
                        class="oe_stat_button"
                        icon="fa-truck"
                        attrs="{'invisible': [('delivery_count', '=', 0)]}" groups="stock.group_stock_user">
                        <field name="delivery_count" widget="statinfo" string="Delivery"/>
                    </button>

                    <button name="action_view_invoice"
                        type="object"
                        class="oe_stat_button"
                        icon="fa-pencil-square-o"
                        attrs="{'invisible': [('invoice_count', '=', 0)]}">
                        <field name="invoice_count" widget="statinfo" string="Invoices"/>
                    </button>
                </xpath>

            </field>
        </record>

        <record id="sale.action_orders_to_invoice" model="ir.actions.act_window">
            <field name="domain">[('invoice_status','=','to invoice'), ('invoice_order','=', True)]</field>
        </record>

    </data>
</odoo>
